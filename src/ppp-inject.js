var q=function(H){if(!H._ppp_info_)H._ppp_info_={};return H._ppp_info_},P=function(){let H=null;return function(O,N){if(!O&&H){N(H);return}let U=new URL(location.href).hostname;chrome.storage.local.get(["global",U],(W)=>{let V=W[U]||{},D=W.global||{disable:!1,speed:1.5};if(!V.enable)if(D.disable)V.stop=!0,V.speed=0;else V.speed=D.speed;H=V,N(V)})}}(),L=function(){let H=null;function O(){H=null,P(!1,(N)=>{if(N.stop)chrome.runtime.sendMessage({type:"UPDATE_ICON",stop:!0});else chrome.runtime.sendMessage({type:"UPDATE_ICON",leq:R.isActive(),speed:Q.activeSpeed()})})}return function(){if(H)return;H=setTimeout(O,300)}}(),Q=function(){let H=Object.getOwnPropertyDescriptor(HTMLMediaElement.prototype,"playbackRate"),O=0;function N(j){if(j&&j.parentNode)O=j.playbackRate}function U(j,B,G){B.use_speed=G,H.set.call(j,G),N(j)}function W(j){let B=j.target,G=q(B);if(G.repair_rate_count<20){let M=G.use_speed||G.to_speed;if(M>0){if(M!==B.playbackRate){G.back_speed=B.playbackRate,G.repair_rate_count=(G.repair_rate_count||0)+1,U(B,G,M);return}}}N(B)}function V(j){let B=j.target,G=q(B);if(G.waiting_count=(G.waiting_count||0)+1,G.waiting_count>2&&B.playbackRate>1)U(B,G,1),setTimeout(()=>{F(B)},60000)}function D(j){let B=j.currentTime,G=0,M=-1,w=1/0;if(j.buffered&&j.buffered.length>0)for(let Z=j.buffered.length-1;Z>=0;Z--){let S=j.buffered.start(Z),J=j.buffered.end(Z);if(S>B){if(S>M){if(w-S<0.1)w=J;continue}else if(M-J<0.1){M=S;continue}M=S,w=J}else{if(J>=B)if(M-J<0.1)G=w-B;else G=J-B;break}}return G}function F(j){let B=q(j);if(j.playbackRate!==B.to_speed){let G=D(j),M=B.to_speed;if(G/M>180)U(j,B,M);else if(B.check_surplus_timer)B.check_surplus_timer=setTimeout(()=>{B.check_surplus_timer=null,F(j)},60000)}}function X(j,B){if(j.readyState<1){setTimeout(()=>{X(j,B)},500);return}if(B.src!==j.src)B.src=j.src,B.waiting_count=0,B.repair_rate_count=0;if(B.to_speed>0){if(!j.duration||j.duration===1/0||isNaN(j.duration)){U(j,B,1);return}U(j,B,B.to_speed)}}return{activeSpeed(){return O},check(j,B){if(B>0){let G=q(j);if(!G.inied)G.inied=!0,G.back_speed=j.playbackRate,j.addEventListener("ratechange",W),j.addEventListener("waiting",V);G.to_speed=B,X(j,G)}},stop(j){let B=q(j);if(B.back_speed){if(j.playbackRate!=B.back_speed)H.set.call(j,B.back_speed)}}}}(),R=function(){let H=null;function O(){if(!H)H=new(window.AudioContext||window.webkitAudioContext);return H}let N=0.005,U=0.2,W=0,V=0,D={},F=null,X=!1;function j(J,K,E){chrome.runtime.sendMessage({type:"UPDATE_LEQ_DATA",data:Array.from(J),length:K,gain:D.gainValue}).then((A)=>{if(A)X=!0;else X=!1}).catch(()=>{X=!1})}function B(J){if(J===D.video&&J.src===D.src)return!0;G();try{let K=J.captureStream();if(K)return D={stream:O().createMediaStreamSource(K),video:J,src:J.src},!0}catch(K){console.error("Failed to initialize media stream",K)}return!1}function G(){if(M(),D.video)D.video.muted=!1;if(D.stream)D.stream.disconnect();if(D.gainNode)D.gainNode.disconnect();D={},L()}function M(){if(F){if(F.timer)clearInterval(F.timer);if(D.stream)D.stream.disconnect(F.node);F.node.disconnect(),F=null}}function w(J){if(!D.stream)return;let K=Math.round(J*1000)/1000;if(!K||Math.abs(K-1)<0.05)return;if(!D.gainNode)D.gainNode=O().createGain(),D.gainNode.connect(O().destination),D.stream.connect(D.gainNode);console.log("[ppp] gain",K),D.gainValue=K,D.gainNode.gain.value=K,D.video.muted=!0,L()}function Z(){if(!D.stream)return;console.log("[ppp] init analyzer"),M(),F={node:O().createAnalyser(),data_sum:0,data_max:0,data_count:0,tick_count:0},F.node.fftSize=2048,D.stream.connect(F.node),F.bufferLength=F.node.frequencyBinCount,F.data=new Uint8Array(F.bufferLength),F.timer=setInterval(S,Math.floor(16.666666666666668))}function S(){if(D.video.paused)return;F.tick_count++;let{bufferLength:J,data:K}=F;try{F.node.getByteTimeDomainData(K)}catch($){console.log($),M();return}let E=0;for(let $=0;$<J;$++){let Y=K[$]/1280;if(E+=Math.pow(Y,2),Y>F.data_max)F.data_max=Y}let A=Math.sqrt(E/J);if(A>N)F.data_sum+=A,F.data_count+=1;let T=F.tick_count;if(F.data_count>100&&T>120&&T%60===0){let $=F.data_count/T;if(console.log("[ppp] tick",$.toFixed(2)),$>=U||T*D.video.playbackRate>7200){let Y=(F.data_max+F.data_sum/F.data_count)/2;if(console.log("[ppp] average volume: ",Y,"min limit:",W,"max limit:",V),Y>0){if(Y>V)w(V/Y);else if(Y<W)w(1+W/Y)}if(!X){M();return}}}if(X)j(K,J,T)}return{isActive(){return!!D.stream&&!!D.gainNode},check(J,K){if(W=K.min_loudness,V=K.max_loudness,B(J)){if(!F)Z()}},stop(J){if(!J||D.video===J)G()},send_audio_data(J){if(J){if(X=!0,!D.video){for(let K of document.querySelectorAll("video"))if(!K.paused&&!K.ended&&!K.muted){if(B(K)){Z();return}}return}if(!F)Z()}else X=!1}}}();window.Ppp=function(H,O){H.muted=!1,P(!!O,(N)=>{if(N.stop)console.log("[ppp] \uD83D\uDE45\uD83C\uDFFB",H),Q.stop(H),R.stop();else if(isGoodVideo(H))if(console.log("[ppp] \uD83C\uDF9Bï¸",H),Q.check(H,N.speed),N.enable_EQ)R.check(H,N);else R.stop();L()})};chrome.runtime.onMessage.addListener((H,O,N)=>{switch(console.log("onMessage",H.type),H.type){case"Refresh":for(let U of document.querySelectorAll("video"))if(q(U).to_speed)Ppp(U,!0);N(!0);break;case"GetAudioData":R.send_audio_data(!0);break;case"StopAudioData":R.send_audio_data(!1);break}});
