var u=function(){let i=null,r=null,l=null;function c(){return new Promise((n,t)=>{chrome.tabs.query({active:!0,currentWindow:!0},(a)=>{let d=a[0].url;i=a[0].id,r=new URL(d).hostname,n(r)})})}function o(n){return new Promise((t,a)=>{chrome.storage.local.get(["global",n],(d)=>{if(l)for(let p in d)l[p]=d[p];else l=d;t(l)})})}async function _(n){if(n=n||r,!n)n=await c(),await o(n);else if(n!=="global"&&n!==r||!l||!l[n])await o(n);let t=l&&l[n];if(!t)t={},l[n]=t;if(!t.speed||t.speed<0)t.speed=1.5;if(n!=="global"){if(!(t.min_loudness>0))t.min_loudness=0.1;if(!(t.max_loudness<1))t.max_loudness=0.9}return t}async function e(n,t){let a=await _(t);if(n)for(let d in n)a[d]=n[d];if(t=t||r,t)chrome.storage.local.set({[t]:a})}function s(n,t,a,d){chrome.tabs.sendMessage(n,t).then(a).catch((p)=>{if(d)d(p);else a(void 0,p)})}return{tab_id(){if(i)return Promise.resolve(i);return c().then(()=>{return i})},tab_domain(){if(r)return r;return c()},get_domain_conf:_,set_domain_conf:e,send_message(n){if(i)return chrome.tabs.sendMessage(i,n);else return new Promise((t,a)=>{chrome.tabs.query({active:!0,currentWindow:!0},(d)=>{chrome.tabs.sendMessage(d[0].id,n).then(t).catch(a)})})}}}(),b=function(){let i=document.getElementById("volume_waveform_canvas");function r(l,c,o,_){let e=i.width/o.length;l.lineWidth=2,l.strokeStyle=c,l.beginPath();let s=0;for(let n=0;n<o.length;n+=1){let t=(1-o[n]*_)*i.height;if(n===0)l.moveTo(s,t);else l.lineTo(s,t);s+=e*2}l.stroke()}return{enable(){u.send_message({type:"GetAudioData"})},disable(){u.send_message({type:"StopAudioData"})},draw(l,c,o){if(!i)return!1;let _=i.getContext("2d");i.width=i.clientWidth,i.height=i.clientHeight;let e=Math.ceil(c/50),s=[];for(let n=e-1;n<c;n+=e){let t=1,a=l[n];while(t<e){if(s.length%2===0?l[n-t]>a:l[n-t]<a)a=l[n-t];t+=1}s.push(a/1280)}if(r(_,"rgb(66, 124, 190)",s,1),o&&o!=1)r(_,"rgb(104, 164, 112)",s,o);return!0}}}(),m=function(){function i(e,s,n){if(typeof s==="string")s=parseFloat(s);let t=Math.floor((s+(n||0)+0.0001)*10)/10;if(isNaN(t))return;u.set_domain_conf({speed:t<0.5?0.5:t>4?4:t},e)}function r(e,s,n,t){let a=document.getElementById(s);if(!a)a=document.createElement("div"),a.id=s,a.className="speed_range_bar flex_block",a.innerHTML=`<div><div class="btn reduce_btn" style="margin:0 10px 20px 0"></div></div><div style="flex:1;"><input class="speed_range_input" type="range" min="0.5" max="4" step="0.1" value="1"/><div class="speed_number_bar">${[["0.5","15%"],["1","13.5%"],["1.5","13.5%"],["2","27%"],["3","24.5%"],["4","5%"]].map((d)=>`<div style="width:${d[1]}"><span>${d[0]}</span></div>`).join("")}</div></div><div><div class="btn add_btn" style="margin:0 0 20px 10px"></div></div>`,a.querySelector(".reduce_btn").addEventListener("click",(d)=>{i(e,a.querySelector("input").value,-0.1)}),a.querySelector(".add_btn").addEventListener("click",(d)=>{i(e,a.querySelector("input").value,0.1)}),a.querySelector(".speed_number_bar").addEventListener("click",(d)=>{if(d.target.tagName==="SPAN")i(e,d.target.textContent)}),a.querySelector("input").addEventListener("input",(d)=>{if(d.target.disabled)return;i(e,d.target.value)}),a.setSpeedValue=function(d){a.querySelector("input").value=d},document.getElementById(n).appendChild(a);return a.setSpeedValue(t),a}function l(e,s){let n=document.getElementById(e);if(s&&n)s(n);return n}function c(e,s){if(typeof e==="string")e=document.getElementById(e);if(e)for(let n in s)e.style[n]=s[n]}function o(e,s){if(typeof e==="string")e=document.getElementById(e);if(e)for(let n in s)if(s[n])e.classList.add(n);else e.classList.remove(n)}async function _(e){e=e||await u.tab_domain();let s=await u.get_domain_conf(e),n=await u.get_domain_conf("global");if(o("global_group",{disabled:n.disable,hide:s.stop}),o("global_enable_btn",{on:!n.disable}),l("global_speed_span",(t)=>t.textContent=`${n.speed}x`),n.disable)l("global_speed_range",(t)=>t.remove());else r("global","global_speed_range","global_speed_solt",n.speed);if(e&&/\./.test(e)){if(o("domain_group",{enabled:s.enable,stop:s.stop}),l("domain_span",(t)=>{t.textContent=`${e}`,t.style.backgroundImage=`url('http://${e}/favicon.ico')`}),o("domain_stop_btn",{on:s.stop}),o("domain_enable_btn",{on:s.enable}),l("domain_speed_span",(t)=>t.textContent=`${s.speed}x`),s.enable)r(e,"domain_speed_range","domain_speed_solt",s.speed);else l("domain_speed_range",(t)=>t.remove());if(o("domain_EQ_solt",{enable:s.enable_EQ}),o("domain_EQ_enable_btn",{on:s.enable_EQ}),c("volume_loudness_min_line",{bottom:`${(s.min_loudness||0.2)*100}%`}),c("volume_loudness_max_line",{bottom:`${(s.max_loudness||0.8)*100}%`}),!s.stop&&s.enable_EQ)b.enable()}else l("domain_group",(t)=>{t.style.display="none"});if(s.stop||!s.enable_EQ)b.disable()}return _}();(async function(){await m();function i(o,_){let e=chrome.i18n.getMessage(_);if(e)document.getElementById(o).innerHTML=e}function r(o,_,e){document.getElementById(o).addEventListener(_,e)}function l(o,_){let e=null;document.getElementById(o).addEventListener("mousedown",(s)=>{if(s.target.id=="volume_loudness_min_slider_btn"||s.target.id=="volume_loudness_max_slider_btn")e=s.target,document.body.style.userSelect="none",s.preventDefault()}),document.addEventListener("mousemove",(s)=>{if(!e)return;_(s,e)}),document.addEventListener("mouseup",(s)=>{if(!e)return;_(s,e),e=null,document.body.style.userSelect=""})}i("popup_speed","popup_speed"),i("popup_loudness_eq","popup_loudness_eq"),i("popup_loudness_eq_desc","popup_loudness_eq_desc"),i("global_speed_label","global_speed_label"),r("global_enable_btn","click",(o)=>{let e=o.target.classList.contains("on");u.set_domain_conf({disable:e},"global")}),r("domain_stop_btn","click",(o)=>{let e=o.target.classList.contains("on");u.set_domain_conf({stop:!e})}),r("domain_enable_btn","click",(o)=>{let e=o.target.classList.contains("on");u.set_domain_conf({enable:!e})}),r("domain_EQ_enable_btn","click",(o)=>{let e=o.target.classList.contains("on");u.set_domain_conf({enable_EQ:!e})});let c=document.getElementById("domain_volume_range");if(c){let o=await u.get_domain_conf();l("domain_volume_range",(_,e)=>{let s=c.getBoundingClientRect(),t=1-(_.clientY-s.top)/s.height;switch(t=Math.round(Math.max(0.1,Math.min(1,t))*100)/100,e.id){case"volume_loudness_min_slider_btn":if(t<Math.min(o.max_loudness,1))o.min_loudness=t,e.parentNode.style.bottom=`${t*100}%`;break;case"volume_loudness_max_slider_btn":if(t>Math.max(0,o.min_loudness))o.max_loudness=t,e.parentNode.style.bottom=`${t*100}%`;break}if(_.type==="mouseup")u.set_domain_conf({})})}})();chrome.runtime.onMessage.addListener((i,r,l)=>{if(!(r.tab?r.tab.id:null))return;switch(console.log("onMessage",i.type),i.type){case"UPDATE_LEQ_DATA":l(b.draw(i.data,i.length,i.gain));break}});chrome.storage.onChanged.addListener((i,r)=>{if(r==="local")m(),u.send_message({type:"Refresh"}).catch(()=>{u.tab_id().then((l)=>{chrome.scripting.executeScript({target:{tabId:l,allFrames:!0},files:["src/ppp-inject.js"]}).then(()=>{m()})})})});
